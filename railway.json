{
  "build": {
    "builder": "DOCKERFILE"
  },
  "deploy": {
    "numReplicas": 1,
    "sleepApplication": true,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  },
  "services": [
    {
      "image": "redis:7-alpine",
      "name": "redis"
    },
    {
      "image": "postgres:16-alpine",
      "name": "postgres",
      "env": {
        "POSTGRES_USER": "${{POSTGRES_USER}}",
        "POSTGRES_PASSWORD": "${{POSTGRES_PASSWORD}}",
        "POSTGRES_DB": "${{POSTGRES_DB}}"
      }
    },
    {
      "name": "vibomat-api",
      "rootDirectory": "/",
      "build": {
        "builder": "DOCKERFILE",
        "dockerfilePath": "backend/Dockerfile"
      },
      "source": {
        "repo": "https://github.com/dwdozier/vibomat"
      },
      "env": {
        "RAILWAY_DOCKERFILE_PATH": "backend/Dockerfile",
        "DATABASE_URL": "${{postgres.DATABASE_URL}}",
        "REDIS_URL": "redis://${{redis.REDIS_HOST}}:${{redis.REDIS_PORT}}",
        "SPOTIFY_CLIENT_ID": {
          "description": "Your Spotify Client ID"
        },
        "SPOTIFY_CLIENT_SECRET": {
          "description": "Your Spotify Client Secret"
        },
        "FASTAPI_SECRET": {
          "description": "Random string for session security",
          "generator": "SECRET"
        },
        "GEMINI_API_KEY": {
          "description": "Google Gemini API Key",
          "required": false
        },
        "PORT": "8000"
      },
      "startCommand": "uvicorn backend.app.main:app --host 0.0.0.0 --port 8000"
    },
    {
      "name": "vibomat-worker",
      "rootDirectory": "/",
      "build": {
        "builder": "DOCKERFILE",
        "dockerfilePath": "backend/Dockerfile"
      },
      "source": {
        "repo": "https://github.com/dwdozier/vibomat"
      },
      "env": {
        "RAILWAY_DOCKERFILE_PATH": "backend/Dockerfile",
        "DATABASE_URL": "${{postgres.DATABASE_URL}}",
        "REDIS_URL": "redis://${{redis.REDIS_HOST}}:${{redis.REDIS_PORT}}",
        "SPOTIFY_CLIENT_ID": "${{vibomat-api.SPOTIFY_CLIENT_ID}}",
        "SPOTIFY_CLIENT_SECRET": "${{vibomat-api.SPOTIFY_CLIENT_SECRET}}",
        "GEMINI_API_KEY": "${{vibomat-api.GEMINI_API_KEY}}"
      },
      "startCommand": "taskiq worker backend.app.core.tasks:broker"
    },
    {
      "name": "vibomat-ui",
      "rootDirectory": "/frontend",
      "build": {
        "builder": "DOCKERFILE",
        "dockerfilePath": "Dockerfile"
      },
      "source": {
        "repo": "https://github.com/dwdozier/vibomat"
      },
      "env": {
        "RAILWAY_DOCKERFILE_PATH": "Dockerfile",
        "VITE_API_TARGET": "https://${{vibomat-api.RAILWAY_PUBLIC_DOMAIN}}",
        "PORT": "80"
      }
    }
  ]
}
