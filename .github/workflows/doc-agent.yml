name: Documentation Agent

on:
  push:
    branches:
      - main
    paths:
      - 'backend/app/**'
      - 'frontend/src/**'
      - 'pyproject.toml'
      - 'frontend/package.json'
      - 'docker-compose.yml'
      - 'SETUP.md'
      - 'scripts/agent_docs.py'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # We need history for git diff

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install uv
          uv pip install --system google-genai typer
          # Install other project deps if needed, but for the script, this is enough (plus standard libs)

      - name: Generate Git Diff
        run: |
          # Compare with the previous commit to see what changed in this push
          git diff HEAD^ HEAD > changes.diff
          echo "Diff generated size: $(wc -c < changes.diff) bytes"

      - name: Run Documentation Agent (README)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -s changes.diff ]; then
            python scripts/agent_docs.py update-readme --diff-path changes.diff --readme-path README.md
          else
            echo "No changes in diff, skipping agent."
          fi

      - name: Run Documentation Agent (CONTRIBUTING)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -s changes.diff ]; then
            python scripts/agent_docs.py update-contributing --diff-path changes.diff --contributing-path CONTRIBUTING.md
          fi

      - name: Run Documentation Agent (SETUP)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -s changes.diff ]; then
            python scripts/agent_docs.py update-setup --diff-path changes.diff --setup-path SETUP.md
          fi

      # Future: Add steps for Guides
      # - name: Run Documentation Agent (Guides)
      #   ...

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Auto-update documentation via Gemini Agent"
          title: "docs: Auto-update documentation via Gemini Agent"
          body: |
            This PR was automatically generated by the **Documentation Agent**.

            It analyzed the recent code changes and updated the documentation to reflect the new state of the codebase.

            **Changes:**
            - Updated `README.md` (Tech Stack, Features, or Quick Start).
            - Updated `CONTRIBUTING.md` (Workflows, Testing).
            - Updated `SETUP.md` (Environment, Installation).

            **Reviewer Instructions:**
            1. Verify technical accuracy.
            2. Check for adherence to Google Developer Documentation Style.
          branch: docs/auto-update-gemini
          delete-branch: true
          base: main
